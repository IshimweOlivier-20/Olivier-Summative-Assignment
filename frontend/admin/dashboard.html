<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard - Olivier</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4">
    <h1 class="text-2xl font-semibold">Admin Dashboard</h1>
    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="col-span-2">
        <div id="dashboard-stats" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>

        <div class="mt-6 bg-white p-4 rounded shadow">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-medium">Quick Actions</h2>
            <div class="text-sm text-gray-500">Admin tools</div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <a href="event-edit.html" class="block text-center p-3 bg-indigo-600 text-white rounded">Create Event</a>
            <a href="promo-edit.html" class="block text-center p-3 bg-pink-600 text-white rounded">Create Promo</a>
            <a href="announcement-edit.html" class="block text-center p-3 bg-yellow-600 text-white rounded">Create Announcement</a>
            <a href="users.html" class="block text-center p-3 bg-green-600 text-white rounded">Manage Users</a>
            <a href="notifications.html" class="block text-center p-3 bg-blue-600 text-white rounded">Create Notification</a>
          </div>
        </div>

        <div class="mt-6 bg-white p-4 rounded shadow">
          <h2 class="text-lg font-medium mb-3">Recent Events</h2>
          <div id="recent-events"></div>
        </div>
        <div class="mt-6 bg-white p-4 rounded shadow">
          <h2 class="text-lg font-medium mb-3">Recent Promos</h2>
          <div id="recent-promos"></div>
        </div>

        <div class="mt-6 bg-white p-4 rounded shadow">
          <h2 class="text-lg font-medium mb-3">Recent Announcements</h2>
          <div id="recent-announcements"></div>
        </div>
      </div>

      <aside class="bg-white p-4 rounded shadow">
        <h3 class="text-lg font-medium">Publishing</h3>
        <p class="text-sm text-gray-600 mt-2">Only admins can publish, edit or delete events and content.</p>
        <div class="mt-4">
          <a href="event-edit.html" class="inline-block px-3 py-1 bg-indigo-600 text-white rounded">New Event</a>
        </div>
      </aside>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/toast.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    $(function(){
      // This page must be restricted to admins. Client-side guard:
      if(!isAuthenticated()){ window.location.href = '../login.html'; return; }
      if(!isAdmin()){ showError('Admin access required'); window.location.href = '../index.html'; return; }

      apiGet('/api/dashboard/admin').then(resp=>{
        const data = resp && resp.data ? resp.data : resp;
        $('#dashboard-stats').empty();
        const metrics = [
          ['Total users', data.users?.total_users || 0],
          ['Active users', data.users?.active_users || 0],
          ['Total events', data.events?.total_events || 0],
          ['Upcoming events', data.events?.upcoming_events || 0],
          ['Registrations', data.registrations?.total_registrations || 0],
          ['Promos', data.promos?.total_promos || 0]
        ];
        metrics.forEach(m=>{
          $('#dashboard-stats').append(`<div class="bg-white p-4 rounded shadow"><div class="text-sm text-gray-500">${m[0]}</div><div class="text-2xl font-bold">${m[1]||0}</div></div>`);
        });
      }).catch(()=>$('#dashboard-stats').html('<div class="p-4 bg-white rounded text-red-600">Failed to load dashboard</div>'));

      // Load recent events with admin controls
      function loadRecent(){
        apiGet('/api/events', { limit: 10 }).then(resp=>{
          const list = (resp && resp.data) ? resp.data : resp;
          $('#recent-events').empty();
          (list||[]).slice(0,10).forEach(ev=>{
            const row = $(`<div class="border-t py-3 flex items-center justify-between"><div><div class="font-medium">${ev.title}</div><div class="text-sm text-gray-500">${new Date(ev.starts_at||ev.created_at).toLocaleString()}</div></div><div class="space-x-2"></div></div>`);
            const actions = row.find('div').last();
            actions.append(`<a href="event-edit.html?id=${ev.id}" class="px-2 py-1 bg-yellow-500 text-white rounded">Edit</a>`);
            actions.append(`<button class="delete-event px-2 py-1 bg-red-600 text-white rounded" data-id="${ev.id}">Delete</button>`);
            $('#recent-events').append(row);
          });
        }).catch(()=>$('#recent-events').html('<div class="text-red-600">Failed to load events</div>'));
      }

      // load recent promos and add publish controls
      function loadPromos(){
        apiGet('/api/promos', { limit: 10 }).then(resp=>{
          const list = (resp && resp.data) ? resp.data : resp;
          $('#recent-promos').empty();
          (list||[]).slice(0,10).forEach(p=>{
            const row = $(`<div class="border-t py-3 flex items-center justify-between"><div><div class="font-medium">${p.title}</div><div class="text-sm text-gray-500">${p.created_at}</div></div><div class="space-x-2"></div></div>`);
            const actions = row.find('div').last();
            actions.append(`<a href="promo-edit.html?id=${p.id}" class="px-2 py-1 bg-yellow-500 text-white rounded">Edit</a>`);
            actions.append(`<button class="promo-publish px-2 py-1 bg-green-600 text-white rounded" data-id="${p.id}">Publish</button>`);
            actions.append(`<button class="promo-unpublish px-2 py-1 bg-yellow-600 text-white rounded" data-id="${p.id}">Unpublish</button>`);
            actions.append(`<button class="promo-delete px-2 py-1 bg-red-600 text-white rounded" data-id="${p.id}">Delete</button>`);
            $('#recent-promos').append(row);
          });
        }).catch(()=>$('#recent-promos').html('<div class="text-red-600">Failed to load promos</div>'));
      }

      // load recent announcements and add publish controls
      function loadAnnouncements(){
        apiGet('/api/announcements', { limit: 10 }).then(resp=>{
          const list = (resp && resp.data) ? resp.data : resp;
          $('#recent-announcements').empty();
          (list||[]).slice(0,10).forEach(a=>{
            const row = $(`<div class="border-t py-3 flex items-center justify-between"><div><div class="font-medium">${a.title}</div><div class="text-sm text-gray-500">${a.created_at}</div></div><div class="space-x-2"></div></div>`);
            const actions = row.find('div').last();
            actions.append(`<a href="announcement-edit.html?id=${a.id}" class="px-2 py-1 bg-yellow-500 text-white rounded">Edit</a>`);
            actions.append(`<button class="ann-publish px-2 py-1 bg-green-600 text-white rounded" data-id="${a.id}">Publish</button>`);
            actions.append(`<button class="ann-unpublish px-2 py-1 bg-yellow-600 text-white rounded" data-id="${a.id}">Unpublish</button>`);
            actions.append(`<button class="ann-delete px-2 py-1 bg-red-600 text-white rounded" data-id="${a.id}">Delete</button>`);
            $('#recent-announcements').append(row);
          });
        }).catch(()=>$('#recent-announcements').html('<div class="text-red-600">Failed to load announcements</div>'));
      }

      loadRecent();
      loadPromos();
      loadAnnouncements();

      $('#recent-events').on('click', '.delete-event', function(){
        const id = $(this).data('id');
        if(!confirm('Delete this event?')) return;
        apiDelete('/api/events/' + id).then(()=>{ showSuccess('Deleted'); loadRecent(); }).catch(e=> showError(e.message || 'Failed to delete'));
      });

      // promo actions
      $('#recent-promos').on('click', '.promo-publish', function(){
        const id = $(this).data('id'); if(!confirm('Publish this promo?')) return;
        apiPatch('/api/promos/' + id + '/publish').then(()=>{ showSuccess('Published'); loadPromos(); }).catch(e=> showError(e.message || 'Failed'));
      });
      $('#recent-promos').on('click', '.promo-unpublish', function(){
        const id = $(this).data('id'); if(!confirm('Unpublish this promo?')) return;
        apiPatch('/api/promos/' + id + '/unpublish').then(()=>{ showSuccess('Unpublished'); loadPromos(); }).catch(e=> showError(e.message || 'Failed'));
      });
      $('#recent-promos').on('click', '.promo-delete', function(){
        const id = $(this).data('id'); if(!confirm('Delete this promo?')) return;
        apiDelete('/api/promos/' + id).then(()=>{ showSuccess('Deleted'); loadPromos(); }).catch(e=> showError(e.message || 'Failed'));
      });

      // announcement actions
      $('#recent-announcements').on('click', '.ann-publish', function(){
        const id = $(this).data('id'); if(!confirm('Publish this announcement?')) return;
        apiPatch('/api/announcements/' + id + '/publish').then(()=>{ showSuccess('Published'); loadAnnouncements(); }).catch(e=> showError(e.message || 'Failed'));
      });
      $('#recent-announcements').on('click', '.ann-unpublish', function(){
        const id = $(this).data('id'); if(!confirm('Unpublish this announcement?')) return;
        apiPatch('/api/announcements/' + id + '/unpublish').then(()=>{ showSuccess('Unpublished'); loadAnnouncements(); }).catch(e=> showError(e.message || 'Failed'));
      });
      $('#recent-announcements').on('click', '.ann-delete', function(){
        const id = $(this).data('id'); if(!confirm('Delete this announcement?')) return;
        apiDelete('/api/announcements/' + id).then(()=>{ showSuccess('Deleted'); loadAnnouncements(); }).catch(e=> showError(e.message || 'Failed'));
      });
    });
  </script>
</body>
</html>
