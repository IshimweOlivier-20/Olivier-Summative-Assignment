<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Event Editor - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-3xl mx-auto p-4">
    <h1 class="text-2xl font-semibold">Event Editor</h1>
    <div id="editor" class="mt-4 bg-white p-4 rounded shadow"></div>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/toast.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    $(function(){
      if(!isAuthenticated() || !isAdmin()){ showError('Admin access required'); window.location.href='../login.html'; return; }
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');

      const formHtml = `
        <form id="event-form" class="space-y-3" enctype="multipart/form-data">
          <div><label class="block text-sm">Title</label><input name="title" class="mt-1 w-full border rounded px-3 py-2" required /></div>
          <div><label class="block text-sm">Location</label><input name="location" class="mt-1 w-full border rounded px-3 py-2" required /></div>
          <div><label class="block text-sm">Starts At</label><input name="starts_at" type="datetime-local" class="mt-1 w-full border rounded px-3 py-2" required /></div>
          <div><label class="block text-sm">Ends At</label><input name="ends_at" type="datetime-local" class="mt-1 w-full border rounded px-3 py-2" required /></div>
          <div><label class="block text-sm">Image</label><input name="image" type="file" accept="image/*" class="mt-1" /></div>
          <div><label class="block text-sm">Description</label><textarea name="description" class="mt-1 w-full border rounded px-3 py-2"></textarea></div>
          <div><label class="inline-flex items-center"><input type="checkbox" name="published" class="mr-2"/> Published</label></div>
          <div><button class="px-3 py-1 bg-indigo-600 text-white rounded">Save</button></div>
        </form>
      `;
      $('#editor').html(formHtml);

      if(id){
        apiGet('/api/events/' + id).then(ev=>{
          const f = $('#event-form');
          f.find('[name=title]').val(ev.title);
          f.find('[name=location]').val(ev.location);
          f.find('[name=starts_at]').val(ev.starts_at);
          f.find('[name=ends_at]').val(ev.ends_at);
          f.find('[name=description]').val(ev.description);
          f.find('[name=published]').prop('checked', !!ev.published);
        });
      }

      $('#event-form').on('submit', function(e){
        e.preventDefault();
        const form = document.getElementById('event-form');
        const fd = new FormData(form);
          if(id){
          // update
          apiPost('/api/events/' + id, fd, false, false).then(()=>{ showSuccess('Updated'); window.location.href='../admin/dashboard.html'; }).catch(err=> showError(err.message || 'Update failed'));
        } else {
          apiPost('/api/events', fd, false, false).then(()=>{ showSuccess('Created'); window.location.href='../admin/dashboard.html'; }).catch(err=> showError(err.message || 'Create failed'));
        }
      });
    });
  </script>
</body>
</html>
